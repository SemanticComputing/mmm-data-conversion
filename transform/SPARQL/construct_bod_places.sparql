PREFIX : <https://sdbm.library.upenn.edu/>
PREFIX frbr: <http://www.cidoc-crm.org/frbr/>
PREFIX frbroo: <http://erlangen-crm.org/efrbroo/>
PREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>
PREFIX afn: <http://jena.hpl.hp.com/ARQ/function#>
PREFIX mmm: <http://ldf.fi/mmm/>
PREFIX mmm-schema: <http://ldf.fi/mmm/schema/>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX dct: <http://purl.org/dc/terms/>
PREFIX bod-roles: <https://medieval.bodleian.ox.ac.uk/catalog/authority/roles/>
PREFIX owl: <http://www.w3.org/2002/07/owl#>
PREFIX wgs: <http://www.w3.org/2003/01/geo/wgs84_pos#>

CONSTRUCT {
  ?bod_place_uri a crm:E53_Place ;
    skos:prefLabel ?pref_label ;
    skos:altLabel ?place_label ;
    skos:altLabel ?alt_label ;
    crm:P89_falls_within ?parent_place ;
    owl:sameAs  ?authority_uri ;
    wgs:lat ?lat ;
    wgs:long ?long ;
    mmm-schema:data_provider_url ?bod_place_uri ;
    dct:source mmm-schema:Bodley .
}
WHERE
{
  ?bod_place_uri a crm:E53_Place .
  OPTIONAL { ?bod_place_uri rdfs:label ?place_label }
  OPTIONAL {
    ?bod_place_uri crm:P1_is_identified_by ?appellation .
    ?appellation rdfs:label ?pref_label .
    OPTIONAL { ?appellation crm:P139_has_alternative_form/rdfs:label ?alt_label }
  }
  OPTIONAL { ?bod_place_uri crm:P89_falls_within ?parent_place }
  OPTIONAL {
    ?bod_place_uri crm:P89i_contains ?centroid .
    ?centroid crm:P168_place_is_defined_by ?coords .
    BIND(STRBEFORE(STRAFTER(?coords, "P("), ",") as ?lat)
    BIND(STRBEFORE(STRAFTER(?coords, ","), ")") as ?long)
  }
  OPTIONAL { ?bod_place_uri owl:sameAs ?authority_uri }
  FILTER(!STRENDS(STR(?bod_place_uri), "place-centroid"))
}
